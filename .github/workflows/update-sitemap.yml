name: Auto Update Sitemap

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write         # push branch with changes
  pull-requests: write    # open PR

jobs:
  update-sitemap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: Generate sitemap
        run: |
          echo "ğŸš€ Starting sitemap generation..."
          node scripts/generateSitemap.js
          echo "ğŸ“‹ Checking generated files..."
          if [ -f "public/sitemap.xml" ]; then
            echo "âœ… Sitemap generated successfully"
            echo "ğŸ“Š File size: $(du -h public/sitemap.xml | cut -f1)"
            echo "ğŸ”¢ URL count: $(grep -c '<url>' public/sitemap.xml || echo 'N/A')"
          else
            echo "âŒ Sitemap file not found!"
            exit 1
          fi
        env:
          SITEMAP_BACKEND_URL: ${{ secrets.VITE_BACKEND_URL }}
          VITE_BACKEND_URL: ${{ secrets.VITE_BACKEND_URL }}
          VITE_BUNNY_CDN_URL: ${{ secrets.VITE_BUNNY_CDN_URL }}
          FRONTEND_URL: 'https://valvrareteam.net'

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ğŸ¤– Auto-update sitemap - $(date -u +'%Y-%m-%d %H:%M UTC')"
          title: "ğŸ¤– Auto-update sitemap"
          body: |
            Automated sitemap update generated by GitHub Actions.
            
            **Details:**
            - ğŸƒ Run ID: ${{ github.run_id }}
            - ğŸ¯ Trigger: ${{ github.event_name }}
            - â° Timestamp: $(date -u +'%Y-%m-%d %H:%M UTC')
            - ğŸŒ Frontend URL: https://valvrareteam.net
            
            **Changes:**
            - Updated sitemap.xml with latest novel and chapter URLs
            - Generated Vietnamese-friendly URLs for better SEO
            
            This PR was created automatically and can be safely merged.
          branch: "bot/sitemap-${{ github.run_id }}"
          base: master
          labels: |
            automated
            sitemap
            enhancement
          draft: false
          add-paths: |
            public/sitemap.xml
          delete-branch: true

      - name: Log completion status
        if: always()
        run: |
          if [ "${{ steps.create-pr.outputs.pull-request-number }}" != "" ]; then
            echo "âœ… Pull request created successfully: #${{ steps.create-pr.outputs.pull-request-number }}"
            echo "ğŸ”— URL: ${{ steps.create-pr.outputs.pull-request-url }}"
            echo "ğŸ“ Branch: ${{ steps.create-pr.outputs.pull-request-head-sha }}"
          else
            echo "â„¹ï¸ No changes detected in sitemap - no PR created"
            echo "ğŸ“„ Current sitemap exists: $([ -f "public/sitemap.xml" ] && echo "yes" || echo "no")"
          fi
          echo "ğŸ‰ Workflow completed successfully!"

      - name: Debug on failure
        if: failure()
        run: |
          echo "âŒ Workflow failed. Checking for common issues..."
          
          # Check if sitemap was generated
          if [ ! -f "public/sitemap.xml" ]; then
            echo "ğŸ” Sitemap file missing - this suggests the generation step failed"
          else
            echo "ğŸ” Sitemap file exists - issue likely in PR creation"
          fi
          
          # Check for network connectivity issues
          echo "ğŸŒ Testing network connectivity..."
          curl -s --max-time 10 https://api.github.com > /dev/null && echo "âœ… GitHub API accessible" || echo "âŒ GitHub API connection failed"
